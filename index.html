<!DOCTYPE html>
<html lang="it">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel='icon' href='data:image/svg+xml,
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
            <text y="0.9em" font-size="85">&#x1FA78</text>
          </svg>'>
  <link rel="stylesheet" href="style.css" />
  <title>Velocità di infusione</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN"
    crossorigin="anonymous"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Itim&display=swap" rel="stylesheet">
</head>

<body class="bg-light">
  <div class="container justify-content-center d-flex">
    <main class="shadow-lg card align-items-center px-5 py-3 mt-5">
      <h1 class="text-danger text-center">Calcola la velocità di infusione</h1>
      <form>
        <div class="mb-2">
          <label class="form-label" for="glycemia-prev">Glicemia precedente (mg/dl):
          </label>
          <input class="form-control" type="number" id="glycemia-prev" />
        </div>
        <div class="mb-2">
          <label class="form-label" for="glycemia-curr">Glicemia attuale (mg/dl):</label>
          <input class="form-control" type="number" id="glycemia-curr" />
        </div>
        <div class="mb-2">
          <label class="form-label" for="rate-prev">Velocità precedente (ml/h):</label>
          <input class="form-control" type="number" id="rate-prev" />
        </div>
        <button class="btn btn-danger w-100" id="calculate">Calcola</button>

      </form>
      <div class="mt-3">
        <p class="text-center">Velocità attuale (ml/h):</p>
        <p class="text-center">
          <span class="text-danger text-bold" id="rate-curr"></span>
        </p>
      </div>
  </div>
  </main>
  <!-- <script src="script.js"></script> -->
  <script>
    'use strict'

    const glycemiaCurrEdges = [
      85, 101, 121, 141, 161, 176, 201, 226, 251, 276, 301, 326, 351, 376, 401, 451,
    ]

    const glycemiaPrevEdges = [
      [120, 151, 201],
      [100, 121, 141, 181, 226, 251, 276],
      [100, 141, 161, 181, 201, 226, 276, 301, 326],
      [100, 141, 161, 181, 201, 226, 276, 301, 326],
      [100, 141, 176, 201, 226, 251, 276, 301, 351],
      [100, 201, 251, 276, 301, 326, 351],
      [100, 151, 201, 251, 276, 301, 326, 351],
      [100, 151, 226, 276, 301, 326, 351, 401],
      [100, 151, 201, 276, 301, 326, 351, 401],
      [100, 201, 251, 301, 326, 376, 401],
      [100, 176, 251, 301, 326, 351, 401],
      [100, 251, 276, 326, 351, 376],
      [100, 201, 276, 326, 351, 376],
      [100, 251, 326, 351, 376],
      [100, 201, 276, 351, 376],
    ]

    const coefficients = [
      [0.6, 0.5, 0.3, 0.1],
      [1.0, 0.9, 0.7, 0.6, 0.5, 0.4, 0.3, 0.1],
      [1.1, 1.0, 0.9, 0.8, 0.7, 0.5, 0.4, 0.3, 0.2, 0.1],
      [1.2, 1.1, 1.0, 0.9, 0.7, 0.6, 0.5, 0.4, 0.2, 0.1],
      [1.4, 1.2, 1.1, 1.0, 0.9, 0.7, 0.5, 0.4, 0.2, 0.1],
      [1.5, 1.2, 1.0, 0.7, 0.5, 0.4, 0.3, 0.2],
      [1.5, 1.4, 1.3, 1.2, 1.0, 0.8, 0.5, 0.3, 0.2],
      [1.8, 1.6, 1.4, 1.2, 1.0, 0.8, 0.5, 0.4, 0.2],
      [2.0, 1.8, 1.6, 1.4, 1.2, 1.0, 0.8, 0.5, 0.4],
      [2.2, 1.8, 1.6, 1.4, 1.2, 1.0, 0.5, 0.4],
      [2.4, 2.0, 1.8, 1.6, 1.4, 1.2, 1.0, 0.5],
      [2.6, 2.0, 1.8, 1.6, 1.4, 1.2, 1],
      [2.8, 2.2, 2.0, 1.8, 1.6, 1.4, 1.2],
      [3.0, 2.2, 2.0, 1.8, 1.6, 1.4],
      [3.2, 2.4, 2.2, 2.0, 1.8, 1.6],
    ]

    const glycemiaPrevInput = document.querySelector('#glycemia-prev')
    const glycemiaCurrInput = document.querySelector('#glycemia-curr')
    const ratePrevInput = document.querySelector('#rate-prev')
    const rateCurrResult = document.querySelector('#rate-curr')
    const calculateBtn = document.querySelector('#calculate')

    const findInterval = (num, edges) => {
      for (let i = 0; i < edges.length; i++) {
        if (num < edges[i]) return i
      }
      return edges.length
    }

    const calculateRate = () => {
      const glycemiaPrev = parseInt(glycemiaPrevInput.value)
      const ratePrev = parseFloat(ratePrevInput.value)
      const glycemiaCurr = parseInt(glycemiaCurrInput.value)

      if (!glycemiaPrev || !glycemiaCurr || !ratePrev) {
        alert('Alimentare tutti i campi!')
        return
      }

      let result = ''
      let i = findInterval(glycemiaCurr, glycemiaCurrEdges)

      switch (i) {
        case 0:
          alert('Stop infusione, avvisa medico')
          break
        case glycemiaCurrEdges.length:
          alert('Avvisa medico')
          break
        default:
          i--
          const j = findInterval(glycemiaPrev, glycemiaPrevEdges[i])
          result = coefficients[i][j] * ratePrev
          result = result.toFixed(1)
      }

      rateCurrResult.innerText = result
    }

    calculateBtn.addEventListener("click", function (e) {
      e.preventDefault();
      calculateRate();
    });

  </script>
</body>

</html>